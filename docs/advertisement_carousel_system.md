# ğŸ¬ å¹¿å‘Šè½®æ’­ç³»ç»Ÿ - å®Œæ•´å®ç°æ–‡æ¡£

## ğŸ“‹ **ç³»ç»Ÿæ¦‚è¿°**

åŸºäºé¡¹ç›®ç°æœ‰MCPæ¶æ„å®ç°çš„å¹¿å‘Šè½®æ’­ç³»ç»Ÿï¼Œä¸å”¤é†’è¯ç³»ç»Ÿå®Œç¾é…åˆï¼Œå®ç°æ™ºèƒ½åŒ–çš„å¹¿å‘Šå±•ç¤ºæ§åˆ¶ã€‚

## ğŸ—ï¸ **ç³»ç»Ÿæ¶æ„**

### **æ ¸å¿ƒç»„ä»¶**

```
ğŸ“¦ å¹¿å‘Šè½®æ’­ç³»ç»Ÿæ¶æ„
â”œâ”€â”€ ğŸ¬ advertisement-server (MCPæœåŠ¡å™¨)
â”‚   â”œâ”€â”€ æ‰«æ ads/ æ–‡ä»¶å¤¹
â”‚   â”œâ”€â”€ æä¾›å¹¿å‘ŠæŸ¥è¯¢MCPå·¥å…·
â”‚   â””â”€â”€ ç‹¬ç«‹è¿›ç¨‹è¿è¡Œ
â”œâ”€â”€ ğŸ¤ wake_word_manager (å”¤é†’çŠ¶æ€æ§åˆ¶)
â”‚   â”œâ”€â”€ ç®¡ç† listening/active çŠ¶æ€
â”‚   â”œâ”€â”€ å‘é€å¹¿å‘Šæ§åˆ¶ä¿¡å·
â”‚   â””â”€â”€ è§¦å‘å¹¿å‘Šæ˜¾ç¤º/éšè—
â””â”€â”€ ğŸ¨ å‰ç«¯WebSocketå¤„ç†å™¨
    â”œâ”€â”€ ç›‘å¬å¹¿å‘Šæ§åˆ¶ä¿¡å·
    â”œâ”€â”€ è°ƒç”¨MCPå·¥å…·è·å–å¹¿å‘Š
    â””â”€â”€ æ§åˆ¶UIæ˜¾ç¤ºçŠ¶æ€
```

## ğŸ“‚ **æ–‡ä»¶ç»“æ„**

### **æ–°å¢æ–‡ä»¶**
```
ğŸ“¦ TheProjectYin/
â”œâ”€â”€ ads/                                    # ğŸ†• å¹¿å‘Šè§†é¢‘æ–‡ä»¶å¤¹
â”‚   â”œâ”€â”€ README.md                          # è‡ªåŠ¨ç”Ÿæˆçš„ä½¿ç”¨è¯´æ˜
â”‚   â”œâ”€â”€ config.json                        # æ’­æ”¾é…ç½®
â”‚   â””â”€â”€ *.mp4, *.avi, *.mov, *.webm      # å¹¿å‘Šè§†é¢‘æ–‡ä»¶
â””â”€â”€ src/solvia_for_chat/mcpp/
    â””â”€â”€ advertisement_server.py            # ğŸ†• å¹¿å‘ŠMCPæœåŠ¡å™¨
```

### **ä¿®æ”¹æ–‡ä»¶**
```
ğŸ“¦ é…ç½®æ–‡ä»¶ä¿®æ”¹:
â”œâ”€â”€ mcp_servers.json                       # æ·»åŠ  advertisement-server é…ç½®
â”œâ”€â”€ conf.yaml                             # å¯ç”¨ advertisement-server
â”œâ”€â”€ src/solvia_for_chat/server.py         # æ·»åŠ  /ads é™æ€æ–‡ä»¶æœåŠ¡
â”œâ”€â”€ src/solvia_for_chat/conversations/
â”‚   â””â”€â”€ wake_word_manager.py              # é›†æˆå¹¿å‘Šæ§åˆ¶ä¿¡å·
â””â”€â”€ frontend/Frontend-AI/src/renderer/src/services/
    â””â”€â”€ websocket-handler.tsx             # å¤„ç†å¹¿å‘Šæ§åˆ¶æ¶ˆæ¯
```

## ğŸ”§ **æŠ€æœ¯å®ç°**

### **1. MCPæœåŠ¡å™¨ (`advertisement_server.py`)**

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- æ‰«æ `ads/` æ–‡ä»¶å¤¹ä¸­çš„è§†é¢‘æ–‡ä»¶
- æä¾›6ä¸ªMCPå·¥å…·ï¼š
  - `get_advertisement_playlist` - è·å–æ’­æ”¾åˆ—è¡¨
  - `get_next_advertisement` - è·å–ä¸‹ä¸€ä¸ªå¹¿å‘Š
  - `get_current_advertisement` - è·å–å½“å‰å¹¿å‘Š
  - `refresh_advertisements` - åˆ·æ–°å¹¿å‘Šåˆ—è¡¨
  - `get_advertisement_stats` - è·å–ç»Ÿè®¡ä¿¡æ¯
  - `welcome_message` - è·å–æ¬¢è¿æ¶ˆæ¯

**é…ç½®ç‰¹æ€§**ï¼š
- éšæœºæ’­æ”¾æ¨¡å¼
- è‡ªåŠ¨åˆ‡æ¢ (15ç§’é—´éš”)
- å¾ªç¯æ’­æ”¾åˆ—è¡¨
- æ’­æ”¾ç»Ÿè®¡è¿½è¸ª

### **2. å”¤é†’çŠ¶æ€é›†æˆ (`wake_word_manager.py`)**

**å¹¿å‘Šæ§åˆ¶é€»è¾‘**ï¼š
```python
"advertisement_control": {
    "should_show_ads": current_state == 'listening',  # åªåœ¨æœªå”¤é†’æ—¶æ˜¾ç¤º
    "control_action": "start_ads" if current_state == 'listening' else "stop_ads",
    "trigger_reason": action  # wake_up/sleep/ignored
}
```

### **3. é™æ€æ–‡ä»¶æœåŠ¡ (`server.py`)**

**æ–°å¢æŒ‚è½½ç‚¹**ï¼š
```python
self.app.mount(
    "/ads",                              # URLè·¯å¾„
    CORSStaticFiles(directory="ads"),    # æœ¬åœ°ç›®å½•
    name="advertisements",               # æœåŠ¡åç§°
)
```

### **4. å‰ç«¯æ¶ˆæ¯å¤„ç† (`websocket-handler.tsx`)**

**å¹¿å‘Šæ§åˆ¶å“åº”**ï¼š
```typescript
if (advertisement_control) {
  const { should_show_ads, control_action, trigger_reason } = advertisement_control;
  
  if (control_action === 'start_ads') {
    // å¯åŠ¨å¹¿å‘Šè½®æ’­
    console.log('ğŸ¬ å¼€å§‹æ’­æ”¾å¹¿å‘Šè½®æ’­');
  } else if (control_action === 'stop_ads') {
    // åœæ­¢å¹¿å‘Šæ’­æ”¾
    console.log('ğŸ›‘ åœæ­¢å¹¿å‘Šæ’­æ”¾');
  }
}
```

## ğŸ”„ **å®Œæ•´å·¥ä½œæµç¨‹**

### **å¯åŠ¨é˜¶æ®µ**
1. **æœåŠ¡å™¨å¯åŠ¨** â†’ `advertisement-server` MCPæœåŠ¡å™¨è‡ªåŠ¨å¯åŠ¨
2. **æ‰«æå¹¿å‘Š** â†’ è‡ªåŠ¨æ‰«æ `ads/` æ–‡ä»¶å¤¹ï¼Œæ³¨å†Œå¯ç”¨å¹¿å‘Š
3. **å‰ç«¯è¿æ¥** â†’ WebSocketè¿æ¥å»ºç«‹ï¼Œæ£€æµ‹åˆ° `listening` çŠ¶æ€
4. **è°ƒç”¨MCPå·¥å…·** â†’ å‰ç«¯è°ƒç”¨ `get_advertisement_playlist` è·å–æ’­æ”¾åˆ—è¡¨
5. **å¼€å§‹è½®æ’­** â†’ æ˜¾ç¤ºå¹¿å‘Šè½®æ’­ç•Œé¢ï¼Œ15ç§’è‡ªåŠ¨åˆ‡æ¢

### **ç”¨æˆ·äº¤äº’é˜¶æ®µ**
6. **å”¤é†’æ£€æµ‹** â†’ ç”¨æˆ·è¯´ï¼š"å¿ƒæµ·ï¼Œä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
7. **çŠ¶æ€åˆ‡æ¢** â†’ `wake_word_manager` åˆ‡æ¢åˆ° `active` çŠ¶æ€
8. **å¹¿å‘Šåœæ­¢** â†’ å‘é€ `stop_ads` æ§åˆ¶ä¿¡å·
9. **ç•Œé¢åˆ‡æ¢** â†’ å‰ç«¯éšè—å¹¿å‘Šï¼Œæ˜¾ç¤ºVTuberå¯¹è¯ç•Œé¢
10. **æ­£å¸¸å¯¹è¯** â†’ VTuberå¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œæ­£å¸¸å·¥ä½œ

### **å¯¹è¯ç»“æŸé˜¶æ®µ**
11. **ç»“æŸæ£€æµ‹** â†’ ç”¨æˆ·è¯´ï¼š"è°¢è°¢ï¼Œå†è§"
12. **çŠ¶æ€å›å½’** â†’ åˆ‡æ¢å› `listening` çŠ¶æ€
13. **å¹¿å‘Šæ¢å¤** â†’ å‘é€ `start_ads` æ§åˆ¶ä¿¡å·
14. **é‡æ–°è½®æ’­** â†’ å‰ç«¯é‡æ–°è°ƒç”¨MCPå·¥å…·ï¼Œç»§ç»­å¹¿å‘Šè½®æ’­

## ğŸ¬ **å¹¿å‘Šå†…å®¹ç®¡ç†**

### **æ”¯æŒçš„è§†é¢‘æ ¼å¼**
- **MP4** (.mp4) - æ¨èï¼Œå…¼å®¹æ€§æœ€å¥½
- **AVI** (.avi) - ä¼ ç»Ÿæ ¼å¼
- **MOV** (.mov) - Appleæ ¼å¼
- **WebM** (.webm) - Webä¼˜åŒ–æ ¼å¼
- **MKV** (.mkv) - é«˜è´¨é‡æ ¼å¼

### **å»ºè®®è§„æ ¼**
- **è§†é¢‘æ—¶é•¿**: 15-60ç§’
- **åˆ†è¾¨ç‡**: 1920x1080 æˆ– 1280x720
- **æ–‡ä»¶å¤§å°**: < 50MB
- **ç¼–ç æ ¼å¼**: H.264 + AAC (æœ€ä½³å…¼å®¹æ€§)

### **å‘½åè§„èŒƒ**
```
ad_001_å“ç‰Œä»‹ç».mp4
ad_002_äº§å“å±•ç¤º.mp4
ad_003_æ–°å“å‘å¸ƒ.mp4
ad_004_ç‰¹åˆ«ä¼˜æƒ .mp4
ad_005_ç”¨æˆ·è¯„ä»·.mp4
```

## ğŸ”§ **é…ç½®è¯´æ˜**

### **MCPæœåŠ¡å™¨é…ç½® (`mcp_servers.json`)**
```json
{
  "mcp_servers": {
    "advertisement-server": {
      "command": "tf-env\\Scripts\\python.exe",
      "args": ["-m", "src.solvia_for_chat.mcpp.advertisement_server", "--ads-dir=ads"],
      "env": {
        "PYTHONPATH": "."
      }
    }
  }
}
```

### **ä¸»é…ç½®å¯ç”¨ (`conf.yaml`)**
```yaml
mcp_enabled_servers: ["time", "ddg-search", "laundry-assistant", "advertisement-server"]
```

### **å¹¿å‘Šæ’­æ”¾é…ç½® (`ads/config.json`)**
```json
{
  "advertisement_settings": {
    "shuffle_mode": true,              // éšæœºæ’­æ”¾
    "auto_advance": true,              // è‡ªåŠ¨åˆ‡æ¢
    "advance_interval_seconds": 15,    // åˆ‡æ¢é—´éš”
    "loop_playlist": true              // å¾ªç¯æ’­æ”¾
  }
}
```

## ğŸ“Š **MCPå·¥å…·è¯¦ç»†è¯´æ˜**

### **1. get_advertisement_playlist**
```python
# è·å–å®Œæ•´å¹¿å‘Šæ’­æ”¾åˆ—è¡¨
arguments: {
  "shuffle": boolean  # æ˜¯å¦éšæœºæ‰“ä¹±åˆ—è¡¨
}

response: {
  "type": "advertisement_playlist",
  "playlist": [...],      # å¹¿å‘Šåˆ—è¡¨
  "total_count": number,  # å¹¿å‘Šæ€»æ•°
  "shuffle_mode": boolean # æ˜¯å¦éšæœºæ¨¡å¼
}
```

### **2. get_next_advertisement**
```python
# è·å–ä¸‹ä¸€ä¸ªå¹¿å‘Š
arguments: {
  "advance": boolean  # æ˜¯å¦è‡ªåŠ¨å‰è¿›
}

response: {
  "type": "advertisement_response",
  "advertisement": {...}, # å¹¿å‘Šä¿¡æ¯
  "index": number,        # å½“å‰ç´¢å¼•
  "total": number         # æ€»æ•°
}
```

### **3. get_current_advertisement**
```python
# è·å–å½“å‰å¹¿å‘Š
response: {
  "type": "advertisement_response",
  "advertisement": {
    "id": "ad_001",
    "name": "å“ç‰Œä»‹ç»",
    "url_path": "/ads/ad_001_å“ç‰Œä»‹ç».mp4",
    "size_mb": 25.6,
    "format": ".mp4"
  }
}
```

## ğŸš€ **éƒ¨ç½²å’Œæµ‹è¯•**

### **1. ç³»ç»Ÿéƒ¨ç½²**
```bash
# 1. ç¡®ä¿æ‰€æœ‰æ–‡ä»¶å·²æ­£ç¡®ä¿®æ”¹
# 2. åˆ›å»ºå¹¿å‘Šæ–‡ä»¶å¤¹ (å·²è‡ªåŠ¨åˆ›å»º)
ls ads/

# 3. é‡å¯æœåŠ¡å™¨
python run_server.py

# 4. æ£€æŸ¥MCPæœåŠ¡å™¨çŠ¶æ€
# åœ¨æ—¥å¿—ä¸­æŸ¥çœ‹ "advertisement-server" æ˜¯å¦æˆåŠŸå¯åŠ¨
```

### **2. åŠŸèƒ½æµ‹è¯•**
```bash
# æµ‹è¯•æ­¥éª¤:
# 1. æ‰“å¼€å‰ç«¯åº”ç”¨
npm run dev  # åœ¨ frontend/Frontend-AI ç›®å½•

# 2. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—
# åº”è¯¥çœ‹åˆ°: "ğŸ“Š å¹¿å‘Šæ˜¾ç¤ºçŠ¶æ€: æ˜¾ç¤º"

# 3. æµ‹è¯•å”¤é†’åŠŸèƒ½
# è¯´: "å¿ƒæµ·"
# æ§åˆ¶å°åº”æ˜¾ç¤º: "ğŸ›‘ å¹¿å‘Šç³»ç»Ÿ: åœæ­¢å¹¿å‘Šæ’­æ”¾"

# 4. æµ‹è¯•ç»“æŸåŠŸèƒ½  
# è¯´: "å†è§"
# æ§åˆ¶å°åº”æ˜¾ç¤º: "ğŸ¬ å¹¿å‘Šç³»ç»Ÿ: å¼€å§‹æ’­æ”¾å¹¿å‘Šè½®æ’­"
```

### **3. æ·»åŠ æµ‹è¯•å¹¿å‘Š**
```bash
# å°†å¹¿å‘Šè§†é¢‘æ–‡ä»¶å¤åˆ¶åˆ°adsæ–‡ä»¶å¤¹
# ç¤ºä¾‹ï¼š
copy "ç¤ºä¾‹å¹¿å‘Š.mp4" "ads/ad_001_ç¤ºä¾‹å¹¿å‘Š.mp4"

# é‡å¯æœåŠ¡å™¨ä»¥æ‰«ææ–°æ–‡ä»¶
python run_server.py
```

## ğŸ” **æ•…éšœæ’é™¤**

### **å¸¸è§é—®é¢˜**

**1. MCPæœåŠ¡å™¨å¯åŠ¨å¤±è´¥**
```bash
# æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
# å¸¸è§åŸå› ï¼š
# - ads æ–‡ä»¶å¤¹ä¸å­˜åœ¨ (ä¼šè‡ªåŠ¨åˆ›å»º)
# - Pythonç¯å¢ƒé—®é¢˜
# - ä¾èµ–åŒ…ç¼ºå¤±
```

**2. å¹¿å‘Šæ–‡ä»¶æ— æ³•è®¿é—®**
```bash
# æ£€æŸ¥é™æ€æ–‡ä»¶æœåŠ¡
curl http://127.0.0.1:12393/ads/ad_001_ç¤ºä¾‹.mp4

# å¦‚æœ404ï¼Œæ£€æŸ¥ï¼š
# - æ–‡ä»¶æ˜¯å¦åœ¨adsæ–‡ä»¶å¤¹ä¸­
# - æ–‡ä»¶æ ¼å¼æ˜¯å¦æ”¯æŒ
# - æœåŠ¡å™¨æ˜¯å¦æ­£ç¡®æŒ‚è½½/adsè·¯å¾„
```

**3. å”¤é†’çŠ¶æ€ä¸å“åº”**
```bash
# æ£€æŸ¥wake_word_manageræ˜¯å¦æ­£å¸¸å·¥ä½œ
# æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ä¸­çš„å¹¿å‘Šæ§åˆ¶ä¿¡å·
# ç¡®è®¤WebSocketè¿æ¥æ­£å¸¸
```

### **è°ƒè¯•å‘½ä»¤**
```python
# æµ‹è¯•MCPæœåŠ¡å™¨
python -m src.solvia_for_chat.mcpp.advertisement_server --ads-dir=ads

# æµ‹è¯•å¹¿å‘Šæ‰«æ
from src.solvia_for_chat.mcpp.advertisement_server import AdvertisementServer
server = AdvertisementServer()
print(f"æ‰¾åˆ° {len(server.advertisements)} ä¸ªå¹¿å‘Š")
```

## ğŸ“ˆ **æ‰©å±•åŠŸèƒ½å»ºè®®**

### **å·²å®ç°åŠŸèƒ½**
- âœ… MCPæ¶æ„é›†æˆ
- âœ… å¤šæ ¼å¼è§†é¢‘æ”¯æŒ  
- âœ… éšæœºæ’­æ”¾æ¨¡å¼
- âœ… å”¤é†’çŠ¶æ€è”åŠ¨
- âœ… æ’­æ”¾ç»Ÿè®¡è¿½è¸ª
- âœ… çƒ­æ›´æ–°å¹¿å‘Šåˆ—è¡¨

### **æœªæ¥æ‰©å±•æ–¹å‘**
- ğŸ”„ **æ™ºèƒ½æ¨è**: åŸºäºç”¨æˆ·åå¥½æ¨èå¹¿å‘Š
- ğŸ“Š **è¯¦ç»†ç»Ÿè®¡**: å¹¿å‘Šè§‚çœ‹æ—¶é•¿ã€ç‚¹å‡»ç‡ç»Ÿè®¡
- ğŸ¨ **è‡ªå®šä¹‰ä¸»é¢˜**: ä¸åŒæ—¶æ®µæ’­æ”¾ä¸åŒç±»å‹å¹¿å‘Š
- ğŸ”Š **éŸ³é¢‘å¹¿å‘Š**: æ”¯æŒçº¯éŸ³é¢‘å¹¿å‘Šæ’­æ”¾
- ğŸ“± **å“åº”å¼å¸ƒå±€**: é€‚é…ä¸åŒå±å¹•å°ºå¯¸
- ğŸ¯ **å®šå‘æŠ•æ”¾**: åŸºäºç”¨æˆ·ç”»åƒçš„ç²¾å‡†æŠ•æ”¾

## ğŸ’¡ **æ€»ç»“**

### **ç³»ç»Ÿä¼˜åŠ¿**
- ğŸ—ï¸ **æ¶æ„ä¼˜é›…**: å®Œå…¨ç¬¦åˆé¡¹ç›®MCPè®¾è®¡ç†å¿µ
- ğŸ”§ **æ¨¡å—åŒ–**: ä¸ç°æœ‰åŠŸèƒ½å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å½±å“  
- ğŸ¯ **æ™ºèƒ½æ§åˆ¶**: åŸºäºç”¨æˆ·äº¤äº’çŠ¶æ€è‡ªåŠ¨æ˜¾ç¤º/éšè—
- ğŸ“ˆ **å¯æ‰©å±•**: é€šè¿‡MCPå·¥å…·å¯è½»æ¾æ‰©å±•åŠŸèƒ½
- ğŸš€ **æ˜“ç»´æŠ¤**: æ¸…æ™°çš„ä»£ç ç»“æ„å’Œå®Œæ•´æ–‡æ¡£

### **æŠ€æœ¯äº®ç‚¹**
- åˆ©ç”¨ç°æœ‰MCPæ¶æ„ï¼Œé›¶ç ´åæ€§é›†æˆ
- å®ç°äº†å”¤é†’çŠ¶æ€ä¸å¹¿å‘Šæ˜¾ç¤ºçš„æ™ºèƒ½è”åŠ¨
- æ”¯æŒçƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯å³å¯æ›´æ–°å¹¿å‘Šå†…å®¹
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- å‰åç«¯åˆ†ç¦»ï¼ŒèŒè´£æ¸…æ™°

**ğŸ‰ å¹¿å‘Šè½®æ’­ç³»ç»Ÿå·²å®Œå…¨å®ç°ï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨äº†ï¼**